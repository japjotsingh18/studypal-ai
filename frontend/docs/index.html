<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyPal AI</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-background">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="header">
        <h1>StudyPal AI</h1>
        <button class="btn history-btn" onclick="toggleHistory()"><i class="fa-solid fa-chart-line"></i> Study History</button>
    </div>

    <div class="container main-content">
        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-header">
                <div class="ai-avatar">ü§ñ</div>
                <h3>AI Study Assistant</h3>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    Hi! I'm StudyPal AI. I'm here to help you stay focused and motivated during your study sessions. Start a study session and I'll support you along the way! üöÄ
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Ask me anything about studying, productivity, or motivation..." maxlength="500">
                <button class="btn" onclick="sendMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Study Section -->
        <div class="study-section">
            <div class="timer-container">
                <div class="progress-ring">
                    <svg>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#00f5ff"/>
                                <stop offset="100%" style="stop-color:#39ff14"/>
                            </linearGradient>
                        </defs>
                        <circle class="progress-bg" cx="100" cy="100" r="90"/>
                        <circle class="progress-bar" cx="100" cy="100" r="90" 
                                stroke-dasharray="565.48" stroke-dashoffset="565.48" id="progressBar"/>
                    </svg>
                    <div class="timer-display" id="timerDisplay">00:00</div>
                </div>
                <div class="motivation-text" id="motivationText">Ready to focus? Start your study session!</div>
                <button class="btn start-btn" id="startBtn" onclick="toggleTimer()">Start Study Session</button>
                <button class="btn finish-btn" id="finishBtn" onclick="finishSession()" style="display: none;">Finish Session</button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalTime">0m</div>
                    <div>Total Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="sessionsCount">0</div>
                    <div>Sessions</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Rewards Section - Full Width Row -->
    <div class="games-section-wrapper">
        <div class="games-section" id="gamesSection">
            <h3><i class="fa-solid fa-gamepad"></i> Game Rewards</h3>
            <div class="unlock-message" id="unlockMessage" style="display: none;">
                üéâ You've earned a break! Choose a mini-game.
            </div>
            <div class="games-grid">
                <div class="game-card" id="game1" onclick="playGame('palindrome')">
                    <div>‚úÖ Palindrome Challenge</div>
                    <small>20min unlock</small>
                </div>
                <div class="game-card" id="game2" onclick="playGame('quiz')">
                    <div>üß† Brain Flash Quiz</div>
                    <small>40min unlock</small>
                </div>
                <div class="game-card" id="game3" onclick="playGame('emoji')">
                    <div>üòä Emoji Puzzle</div>
                    <small>40min unlock</small>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    
    <!-- History Section (Below main content) -->
    <div class="history-section" id="historySection" style="display: none;">
        <div class="history-header">
            <h2><i class="fa-solid fa-chart-line"></i> Study History</h2>
        </div>
        
        <div class="history-content">
            <div id="historyContent">
                <div id="loadingMessage">Loading study sessions...</div>
            </div>
            <div class="chart-container" id="chartContainer" style="display: none;">
                <canvas id="sessionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    </div>

    <!-- Emoji Puzzle Game Overlay -->
    <div id="emojiPuzzleGame" class="emoji-game-overlay" style="display: none;">
        <div class="emoji-game-container">
            <div class="emoji-game-header">
                <h2>üß© Emoji Puzzle</h2>
                <div class="emoji-game-stats">
                    <div class="emoji-stat">
                        <span class="emoji-stat-label">High Score:</span>
                        <span id="emojiHighScore">0</span>
                    </div>
                    <div class="emoji-stat">
                        <span class="emoji-stat-label">Time:</span>
                        <span id="emojiTimer" class="emoji-timer">60</span>
                    </div>
                    <div class="emoji-stat">
                        <span class="emoji-stat-label">Round:</span>
                        <span id="emojiRound">1</span>
                    </div>
                </div>
                <button onclick="closeEmojiPuzzle()" class="emoji-close-btn">‚úï</button>
            </div>

            <div id="emojiGameContent" class="emoji-game-content">
                <div class="emoji-sequence-display">
                    <h3>Watch the sequence:</h3>
                    <div id="emojiSequenceContainer" class="emoji-sequence-container"></div>
                </div>

                <div class="emoji-input-section">
                    <h3>Repeat the sequence:</h3>
                    <div id="emojiInputContainer" class="emoji-input-container"></div>
                    <div class="emoji-selection-grid" id="emojiGrid">
                        <button class="emoji-btn" data-emoji="üòÉ">üòÉ</button>
                        <button class="emoji-btn" data-emoji="üê∂">üê∂</button>
                        <button class="emoji-btn" data-emoji="üçé">üçé</button>
                        <button class="emoji-btn" data-emoji="üåü">üåü</button>
                        <button class="emoji-btn" data-emoji="üöÄ">üöÄ</button>
                        <button class="emoji-btn" data-emoji="üéµ">üéµ</button>
                        <button class="emoji-btn" data-emoji="üî•">üî•</button>
                        <button class="emoji-btn" data-emoji="üíé">üíé</button>
                        <button class="emoji-btn" data-emoji="üåà">üåà</button>
                        <button class="emoji-btn" data-emoji="‚ö°">‚ö°</button>
                        <button class="emoji-btn" data-emoji="üéØ">üéØ</button>
                        <button class="emoji-btn" data-emoji="üèÜ">üèÜ</button>
                    </div>
                </div>

                <div class="emoji-feedback" id="emojiFeedback"></div>

                <div class="emoji-game-controls">
                    <button id="emojiPauseBtn" onclick="pauseEmojiPuzzle()" class="emoji-control-btn">‚è∏Ô∏è Pause</button>
                    <button onclick="startEmojiPuzzle()" class="emoji-control-btn">üîÑ Restart</button>
                </div>
            </div>

            <div id="emojiEndScreen" class="emoji-end-screen" style="display: none;">
                <h2>üéÆ Game Over!</h2>
                <div class="emoji-final-stats">
                    <div class="emoji-final-score">
                        <span class="emoji-score-label">Final Score:</span>
                        <span id="emojiFinalScore" class="emoji-score-value">0</span>
                    </div>
                    <div id="emojiPerformance" class="emoji-performance-message"></div>
                </div>
                <div class="emoji-end-controls">
                    <button onclick="startEmojiPuzzle()" class="emoji-control-btn primary">üîÑ Play Again</button>
                    <button onclick="closeEmojiPuzzle()" class="emoji-control-btn">‚ùå Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-icon">‚ö†Ô∏è</span>
                <h3 class="modal-title">Finish Study Session</h3>
            </div>
            <div class="modal-message">
                Are you sure you want to finish your current study session? Your progress will be saved.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmFinishSession()">Finish Session</button>
            </div>
        </div>
    </div>

    <!-- Palindrome Challenge Mini-Game -->
    <div id="palindromeGame" class="palindrome-game-overlay" style="display: none;">
        <div class="palindrome-game-container">
            <div class="palindrome-game-header">
                <h2 class="palindrome-title">üéÆ Palindrome Challenge</h2>
                <p class="palindrome-subtitle">Enter a word or sentence to check if it's a palindrome!</p>
            </div>
            
            <div class="palindrome-input-section">
                <input 
                    type="text" 
                    id="palindromeInput" 
                    class="palindrome-input" 
                    placeholder="Type your text here..."
                    maxlength="100"
                />
            </div>
            
            <div class="palindrome-button-section">
                <button id="checkPalindromeBtn" class="palindrome-check-btn" onclick="checkPalindrome()">
                    Check Palindrome
                </button>
            </div>
            
            <div id="palindromeResult" class="palindrome-result" style="opacity: 0;">
                <p id="palindromeResultText"></p>
            </div>
            
            <div class="palindrome-controls">
                <button class="palindrome-control-btn clear-btn" onclick="clearPalindromeGame()">
                    Clear
                </button>
                <button class="palindrome-control-btn close-btn" onclick="closePalindromeGame()">
                    Close Game
                </button>
            </div>
        </div>
    </div>

    <!-- Brain Flash Quiz Game -->
    <div id="brainFlashQuiz" class="quiz-game-overlay" style="display: none;">
        <div class="quiz-game-container">
            <div class="quiz-header">
                <h2 class="quiz-title">üß† Brain Flash Quiz</h2>
                <div class="quiz-stats">
                    <div class="quiz-timer" id="quizTimer">60</div>
                    <div class="quiz-score">Score: <span id="quizScore">0</span></div>
                    <div class="quiz-high-score">Best: <span id="quizHighScore">0</span></div>
                </div>
            </div>

            <div id="quizGameContent" class="quiz-content">
                <div class="quiz-question-container">
                    <div class="quiz-question-number">Question <span id="questionNumber">1</span></div>
                    <div class="quiz-question" id="quizQuestion">Loading question...</div>
                </div>

                <div class="quiz-options" id="quizOptions">
                    <button class="quiz-option" onclick="selectQuizAnswer(0)">A</button>
                    <button class="quiz-option" onclick="selectQuizAnswer(1)">B</button>
                    <button class="quiz-option" onclick="selectQuizAnswer(2)">C</button>
                    <button class="quiz-option" onclick="selectQuizAnswer(3)">D</button>
                </div>

                <div class="quiz-feedback" id="quizFeedback" style="opacity: 0;"></div>
            </div>

            <div id="quizEndScreen" class="quiz-end-screen" style="display: none;">
                <h3 class="quiz-end-title">üéØ Quiz Complete!</h3>
                <div class="quiz-final-score">
                    Final Score: <span id="finalScore">0</span>
                </div>
                <div class="quiz-performance" id="quizPerformance"></div>
                <div class="quiz-end-controls">
                    <button class="quiz-restart-btn" onclick="startBrainFlashQuiz()">üîÑ Play Again</button>
                    <button class="quiz-close-btn" onclick="closeBrainFlashQuiz()">Close Quiz</button>
                </div>
            </div>

            <div class="quiz-controls">
                <button class="quiz-control-btn quiz-pause-btn" onclick="pauseBrainFlashQuiz()" id="quizPauseBtn">‚è∏Ô∏è Pause</button>
                <button class="quiz-control-btn quiz-exit-btn" onclick="closeBrainFlashQuiz()">‚ùå Exit</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Enhanced Chat Functions
        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message) {
                // Add user message to chat
                addUserMessage(message);
                chatInput.value = '';
                
                // Show typing indicator
                showTypingIndicator();
                
                try {
                    // Send message to backend with timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                    
                    const response = await fetch('http://127.0.0.1:5001/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // Hide typing indicator
                    hideTypingIndicator();
                    
                    if (data.reply) {
                        // Add AI response to chat
                        addAIMessageHTML(data.reply);
                    } else if (data.error) {
                        addAIMessageHTML(`Sorry, there was an error: ${data.error}`);
                    } else {
                        addAIMessageHTML('Sorry, I received an unexpected response. Please try again.');
                    }
                } catch (error) {
                    hideTypingIndicator();
                    console.error('Chat error:', error);
                    
                    if (error.name === 'AbortError') {
                        addAIMessageHTML('Request timed out. Please check your connection and try again.');
                    } else if (error.message.includes('Failed to fetch')) {
                        addAIMessageHTML('Cannot connect to StudyPal AI backend. Please make sure the server is running on port 5001.');
                    } else {
                        addAIMessageHTML(`Connection error: ${error.message}`);
                    }
                }
            }
        }
        
        function addUserMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${currentTime}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addAIMessageHTML(text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${currentTime}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = '<div style="opacity: 0.7; font-style: italic;">StudyPal AI is typing...</div>';
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Add connection test function
        async function testBackendConnection() {
            try {
                const response = await fetch('http://127.0.0.1:5001/api/get-sessions', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    console.log('‚úÖ Backend connection successful');
                    return true;
                } else {
                    console.error('‚ùå Backend connection failed:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Backend connection error:', error);
                return false;
            }
        }
        
        // Test connection on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Test backend connection
            console.log('üîÑ Testing backend connection...');
            const isConnected = await testBackendConnection();
            
            if (!isConnected) {
                // Add connection error message to chat
                const chatMessages = document.getElementById('chatMessages');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message ai-message error-message';
                errorDiv.innerHTML = `
                    <div style="color: #ff6b6b;">
                        ‚ö†Ô∏è Cannot connect to StudyPal AI backend. Please make sure the server is running on http://127.0.0.1:5001
                    </div>
                `;
                chatMessages.appendChild(errorDiv);
            } else {
                console.log('‚úÖ Backend is ready!');
            }
        });
        
        // Add message time styles
        const style = document.createElement('style');
        style.textContent = `
            .message {
                margin-bottom: 1rem;
                padding: 1rem;
                border-radius: 12px;
                max-width: 85%;
                position: relative;
                animation: messageSlideIn 0.3s ease-out;
            }
            
            @keyframes messageSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .message.ai-message {
                background: linear-gradient(135deg, rgba(0, 245, 255, 0.1), rgba(57, 255, 20, 0.1));
                border: 1px solid rgba(0, 245, 255, 0.3);
                color: #e0e0e0;
                margin-right: auto;
            }
            
            .message.user-message {
                background: linear-gradient(135deg, rgba(57, 255, 20, 0.1), rgba(0, 245, 255, 0.1));
                border: 1px solid rgba(57, 255, 20, 0.3);
                color: #e0e0e0;
                margin-left: auto;
            }
            
            .message.error-message {
                background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 107, 107, 0.1));
                border: 1px solid rgba(255, 107, 107, 0.3);
                color: #e0e0e0;
                margin-right: auto;
            }
            
            .message-time {
                font-size: 0.7rem;
                color: rgba(224, 224, 224, 0.5);
                margin-top: 0.5rem;
                text-align: right;
            }
            
            .typing-indicator {
                animation: typingPulse 1.5s ease-in-out infinite;
            }
            
            @keyframes typingPulse {
                0%, 100% { opacity: 0.7; }
                50% { opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        let historyLoaded = false;
        
        // Toggle history section visibility
        function toggleHistory() {
            const historySection = document.getElementById('historySection');
            const historyBtn = document.querySelector('.history-btn');
            
            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';
                historyBtn.textContent = 'üìä Hide History';
                
                // Always reload history data to show latest sessions
                loadStudyHistory();
                historyLoaded = true;
                
                // Smooth scroll to history section
                setTimeout(() => {
                    historySection.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100);
            } else {
                historySection.style.display = 'none';
                historyBtn.innerHTML = '<i class="fa-solid fa-chart-line"></i> Study History';
                
                // Scroll back to top
                window.scrollTo({ 
                    top: 0, 
                    behavior: 'smooth' 
                });
            }
        }
        
        // Study History functionality
        async function loadStudyHistory() {
            const historyContent = document.getElementById('historyContent');
            const chartContainer = document.getElementById('chartContainer');
            
            try {
                const response = await fetch('http://127.0.0.1:5001/api/get-sessions');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch sessions');
                }
                
                if (data.sessions && data.sessions.length > 0) {
                    displaySessionsTable(data.sessions);
                    displaySessionsChart(data.sessions);
                    chartContainer.style.display = 'block';
                } else {
                    historyContent.innerHTML = '<div class="no-sessions">No study sessions found. Start studying to see your progress!</div>';
                }
            } catch (error) {
                console.error('Error loading study history:', error);
                historyContent.innerHTML = `<div class="error-message">Error loading study history: ${error.message}</div>`;
            }
        }
        
        function displaySessionsTable(sessions) {
            const historyContent = document.getElementById('historyContent');
            
            let tableHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Total Time</th>
                            <th>Session Count</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sessions.forEach(session => {
                const totalMinutes = Math.round(session.total_time / 60);
                const date = new Date(session.timestamp).toLocaleString();
                
                tableHTML += `
                    <tr>
                        <td>#${session.id}</td>
                        <td>${totalMinutes} min</td>
                        <td>${session.session_count}</td>
                        <td>${date}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            historyContent.innerHTML = tableHTML;
        }
        
        function displaySessionsChart(sessions) {
            const ctx = document.getElementById('sessionChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.sessionChartInstance) {
                window.sessionChartInstance.destroy();
            }
            
            // Prepare data for chart (last 10 sessions)
            const labels = sessions.map(session => `Session #${session.id}`);
            const timeData = sessions.map(session => Math.round(session.total_time / 60)); // Convert to minutes
            
            // Store the chart instance globally so we can destroy it later
            window.sessionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Study Time (minutes)',
                        data: timeData,
                        backgroundColor: 'rgba(57, 255, 20, 0.6)',
                        borderColor: 'rgba(57, 255, 20, 1)',
                        borderWidth: 2,
                        borderRadius: 5,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    family: 'Roboto Mono'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0',
                                font: {
                                    family: 'Roboto Mono'
                                }
                            },
                            grid: {
                                color: 'rgba(224, 224, 224, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                font: {
                                    family: 'Roboto Mono'
                                }
                            },
                            grid: {
                                color: 'rgba(224, 224, 224, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // Function to refresh history if it's currently visible
        function refreshHistoryIfVisible() {
            const historySection = document.getElementById('historySection');
            if (historySection && historySection.style.display !== 'none') {
                console.log('Refreshing history data...');
                loadStudyHistory();
            }
        }
        
        // Palindrome Game Functions
        function openPalindromeGame() {
            const gameOverlay = document.getElementById('palindromeGame');
            gameOverlay.style.display = 'flex';
            
            // Focus on input after a short delay
            setTimeout(() => {
                document.getElementById('palindromeInput').focus();
            }, 300);
            
            // Clear any previous results
            clearPalindromeResult();
        }
        
        function closePalindromeGame() {
            const gameOverlay = document.getElementById('palindromeGame');
            gameOverlay.style.display = 'none';
            
            // Clear input and results
            clearPalindromeGame();
        }
        
        function clearPalindromeGame() {
            document.getElementById('palindromeInput').value = '';
            clearPalindromeResult();
        }
        
        function clearPalindromeResult() {
            const resultDiv = document.getElementById('palindromeResult');
            resultDiv.style.opacity = '0';
            resultDiv.className = 'palindrome-result';
        }
        
        function showPalindromeResult(message, type) {
            const resultDiv = document.getElementById('palindromeResult');
            const resultText = document.getElementById('palindromeResultText');
            
            resultText.textContent = message;
            resultDiv.className = `palindrome-result ${type}`;
            resultDiv.style.opacity = '1';
        }
        
        function isPalindrome(str) {
            // Remove spaces, punctuation, and convert to lowercase
            const cleaned = str.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
            
            // Check if cleaned string equals its reverse
            return cleaned === cleaned.split('').reverse().join('');
        }
        
        function checkPalindrome() {
            const input = document.getElementById('palindromeInput').value.trim();
            
            // Check if input is empty
            if (input === '') {
                showPalindromeResult('‚ö†Ô∏è Please enter something.', 'warning');
                return;
            }
            
            // Check if it's a palindrome
            if (isPalindrome(input)) {
                showPalindromeResult('‚úÖ It\'s a palindrome!', 'success');
            } else {
                showPalindromeResult('‚ùå Not a palindrome.', 'error');
            }
        }
        
        // Add Enter key support for palindrome input
        document.addEventListener('DOMContentLoaded', function() {
            const palindromeInput = document.getElementById('palindromeInput');
            if (palindromeInput) {
                palindromeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPalindrome();
                    }
                });
            }
        });
        
        // Brain Flash Quiz Functions
        let quizState = {
            isActive: false,
            isPaused: false,
            timeLeft: 60,
            score: 0,
            questionCount: 0,
            currentQuestion: null,
            timer: null
        };

        const quizQuestions = [
            // Math Questions
            { question: "What is 15 √ó 8?", options: ["120", "140", "110", "130"], correct: 0 },
            { question: "What is 144 √∑ 12?", options: ["11", "13", "12", "14"], correct: 2 },
            { question: "What is 7¬≤ + 3¬≤?", options: ["58", "49", "40", "52"], correct: 0 },
            { question: "What is 25% of 80?", options: ["15", "25", "20", "30"], correct: 2 },
            { question: "What is ‚àö64?", options: ["6", "8", "10", "7"], correct: 1 },
            { question: "What is 13 + 29?", options: ["42", "41", "43", "40"], correct: 0 },
            { question: "What is 156 - 89?", options: ["67", "77", "57", "69"], correct: 0 },
            { question: "What is 2¬≥ √ó 5?", options: ["30", "35", "40", "45"], correct: 2 },
            { question: "What is 72 √∑ 8?", options: ["8", "9", "10", "7"], correct: 1 },
            { question: "What is 11 √ó 11?", options: ["111", "121", "131", "141"], correct: 1 },
            
            // Logic Questions
            { question: "If today is Wednesday, what day was it 3 days ago?", options: ["Sunday", "Monday", "Saturday", "Tuesday"], correct: 0 },
            { question: "Which number comes next: 2, 4, 8, 16, ?", options: ["24", "32", "28", "20"], correct: 1 },
            { question: "If A=1, B=2, C=3, what does CAB equal?", options: ["312", "321", "123", "132"], correct: 0 },
            { question: "How many sides does a hexagon have?", options: ["5", "7", "6", "8"], correct: 2 },
            { question: "Which is the odd one out?", options: ["Triangle", "Square", "Circle", "Pentagon"], correct: 2 },
            { question: "If 3 cats catch 3 mice in 3 minutes, how many cats catch 100 mice in 100 minutes?", options: ["100", "33", "3", "10"], correct: 2 },
            { question: "What comes next: Monday, Wednesday, Friday, ?", options: ["Sunday", "Tuesday", "Saturday", "Thursday"], correct: 0 },
            { question: "How many minutes are in 2.5 hours?", options: ["120", "130", "150", "140"], correct: 2 },
            { question: "Which number is missing: 5, 10, 15, ?, 25", options: ["18", "20", "22", "24"], correct: 1 },
            { question: "If you're facing North and turn 270¬∞ clockwise, which direction are you facing?", options: ["West", "South", "East", "North"], correct: 0 }
        ];

        function openBrainFlashQuiz() {
            const quizOverlay = document.getElementById('brainFlashQuiz');
            quizOverlay.style.display = 'flex';
            
            // Load high score
            loadQuizHighScore();
            
            // Start the quiz
            startBrainFlashQuiz();
        }

        function closeBrainFlashQuiz() {
            const quizOverlay = document.getElementById('brainFlashQuiz');
            quizOverlay.style.display = 'none';
            
            // Stop quiz if running
            if (quizState.isActive) {
                stopQuizTimer();
                quizState.isActive = false;
            }
            
            // Reset quiz state
            resetQuizState();
        }

        function startBrainFlashQuiz() {
            // Reset quiz state
            quizState = {
                isActive: true,
                isPaused: false,
                timeLeft: 60,
                score: 0,
                questionCount: 0,
                currentQuestion: null,
                timer: null
            };
            
            // Show game content, hide end screen
            document.getElementById('quizGameContent').style.display = 'block';
            document.getElementById('quizEndScreen').style.display = 'none';
            
            // Update display
            updateQuizDisplay();
            
            // Load first question
            loadNextQuestion();
            
            // Start timer
            startQuizTimer();
        }

        function pauseBrainFlashQuiz() {
            if (!quizState.isActive) return;
            
            const pauseBtn = document.getElementById('quizPauseBtn');
            
            if (quizState.isPaused) {
                // Resume
                quizState.isPaused = false;
                startQuizTimer();
                pauseBtn.textContent = '‚è∏Ô∏è Pause';
                pauseBtn.style.background = 'rgba(0, 0, 0, 0.6)';
            } else {
                // Pause
                quizState.isPaused = true;
                stopQuizTimer();
                pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
                pauseBtn.style.background = 'rgba(57, 255, 20, 0.2)';
            }
        }

        function startQuizTimer() {
            quizState.timer = setInterval(() => {
                if (!quizState.isPaused && quizState.isActive) {
                    quizState.timeLeft--;
                    updateTimerDisplay();
                    
                    if (quizState.timeLeft <= 0) {
                        endBrainFlashQuiz();
                    }
                }
            }, 1000);
        }

        function stopQuizTimer() {
            if (quizState.timer) {
                clearInterval(quizState.timer);
                quizState.timer = null;
            }
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('quizTimer');
            timerElement.textContent = quizState.timeLeft;
            
            // Add warning classes
            timerElement.className = 'quiz-timer';
            if (quizState.timeLeft <= 10) {
                timerElement.classList.add('danger');
            } else if (quizState.timeLeft <= 20) {
                timerElement.classList.add('warning');
            }
        }

        function updateQuizDisplay() {
            document.getElementById('quizScore').textContent = quizState.score;
            document.getElementById('questionNumber').textContent = quizState.questionCount + 1;
            updateTimerDisplay();
        }

        function loadNextQuestion() {
            // Get random question
            const randomIndex = Math.floor(Math.random() * quizQuestions.length);
            quizState.currentQuestion = quizQuestions[randomIndex];
            quizState.questionCount++;
            
            // Update question display
            document.getElementById('quizQuestion').textContent = quizState.currentQuestion.question;
            
            // Update options
            const optionButtons = document.querySelectorAll('.quiz-option');
            optionButtons.forEach((btn, index) => {
                btn.textContent = `${String.fromCharCode(65 + index)}. ${quizState.currentQuestion.options[index]}`;
                btn.className = 'quiz-option';
                btn.disabled = false;
            });
            
            // Clear feedback
            const feedback = document.getElementById('quizFeedback');
            feedback.style.opacity = '0';
            feedback.className = 'quiz-feedback';
            
            // Update display
            updateQuizDisplay();
        }

        function selectQuizAnswer(selectedIndex) {
            if (!quizState.isActive || quizState.isPaused) return;
            
            const optionButtons = document.querySelectorAll('.quiz-option');
            const feedback = document.getElementById('quizFeedback');
            const correctIndex = quizState.currentQuestion.correct;
            
            // Disable all buttons
            optionButtons.forEach(btn => btn.disabled = true);
            
            // Show correct/incorrect styling
            optionButtons[selectedIndex].classList.add(selectedIndex === correctIndex ? 'correct' : 'incorrect');
            optionButtons[correctIndex].classList.add('correct');
            
            // Update score and show feedback
            if (selectedIndex === correctIndex) {
                quizState.score++;
                feedback.textContent = '‚úÖ Correct! +1 point';
                feedback.className = 'quiz-feedback correct';
            } else {
                feedback.textContent = '‚ùå Incorrect! Try the next one';
                feedback.className = 'quiz-feedback incorrect';
            }
            
            feedback.style.opacity = '1';
            
            // Update score display
            document.getElementById('quizScore').textContent = quizState.score;
            
            // Load next question after delay
            setTimeout(() => {
                if (quizState.isActive) {
                    loadNextQuestion();
                }
            }, 1500);
        }

        function endBrainFlashQuiz() {
            quizState.isActive = false;
            stopQuizTimer();
            
            // Hide game content, show end screen
            document.getElementById('quizGameContent').style.display = 'none';
            document.getElementById('quizEndScreen').style.display = 'block';
            
            // Update final score
            document.getElementById('finalScore').textContent = quizState.score;
            
            // Update performance message
            const performance = document.getElementById('quizPerformance');
            let message = '';
            if (quizState.score >= 15) {
                message = 'üèÜ Outstanding! You\'re a genius!';
            } else if (quizState.score >= 10) {
                message = 'üéØ Excellent work! Great focus!';
            } else if (quizState.score >= 6) {
                message = 'üëç Good job! Keep practicing!';
            } else {
                message = 'üí™ Nice try! You\'ll do better next time!';
            }
            performance.textContent = message;
            
            // Check and update high score
            updateQuizHighScore();
        }

        function loadQuizHighScore() {
            const highScore = localStorage.getItem('brainFlashQuizHighScore') || '0';
            document.getElementById('quizHighScore').textContent = highScore;
        }

        function updateQuizHighScore() {
            const currentHighScore = parseInt(localStorage.getItem('brainFlashQuizHighScore') || '0');
            if (quizState.score > currentHighScore) {
                localStorage.setItem('brainFlashQuizHighScore', quizState.score.toString());
                document.getElementById('quizHighScore').textContent = quizState.score;
                
                // Show new high score message
                const performance = document.getElementById('quizPerformance');
                performance.innerHTML = 'üéâ NEW HIGH SCORE! üéâ<br>' + performance.textContent;
            }
        }

        function resetQuizState() {
            quizState = {
                isActive: false,
                isPaused: false,
                timeLeft: 60,
                score: 0,
                questionCount: 0,
                currentQuestion: null,
                timer: null
            };
            
            // Reset pause button
            const pauseBtn = document.getElementById('quizPauseBtn');
            pauseBtn.textContent = '‚è∏Ô∏è Pause';
            pauseBtn.style.background = 'rgba(0, 0, 0, 0.6)';
        }
        
        // Emoji Puzzle Game Functions
        let emojiGameState = {
            isActive: false,
            isPaused: false,
            timeLeft: 60,
            round: 1,
            sequence: [],
            userInput: [],
            timer: null,
            showingSequence: false,
            sequenceIndex: 0
        };

        const emojiOptions = ['üòÉ', 'üê∂', 'üçé', 'üåü', 'üöÄ', 'üéµ', 'üî•', 'üíé', 'üåà', '‚ö°', 'üéØ', 'üèÜ'];

        function openEmojiPuzzle() {
            const emojiOverlay = document.getElementById('emojiPuzzleGame');
            emojiOverlay.style.display = 'flex';
            
            // Load high score
            loadEmojiHighScore();
            
            // Start the game
            startEmojiPuzzle();
        }

        function closeEmojiPuzzle() {
            const emojiOverlay = document.getElementById('emojiPuzzleGame');
            emojiOverlay.style.display = 'none';
            
            // Stop game if running
            if (emojiGameState.isActive) {
                stopEmojiTimer();
                emojiGameState.isActive = false;
            }
            
            // Reset game state
            resetEmojiGameState();
        }

        function startEmojiPuzzle() {
            // Reset game state
            emojiGameState = {
                isActive: true,
                isPaused: false,
                timeLeft: 60,
                round: 1,
                sequence: [],
                userInput: [],
                timer: null,
                showingSequence: false,
                sequenceIndex: 0
            };
            
            // Show game content, hide end screen
            document.getElementById('emojiGameContent').style.display = 'block';
            document.getElementById('emojiEndScreen').style.display = 'none';
            
            // Update display
            updateEmojiDisplay();
            
            // Start first round
            startNewRound();
            
            // Start timer
            startEmojiTimer();
        }

        function pauseEmojiPuzzle() {
            if (!emojiGameState.isActive) return;
            
            const pauseBtn = document.getElementById('emojiPauseBtn');
            
            if (emojiGameState.isPaused) {
                // Resume
                emojiGameState.isPaused = false;
                startEmojiTimer();
                pauseBtn.textContent = '‚è∏Ô∏è Pause';
                pauseBtn.style.background = 'rgba(0, 0, 0, 0.6)';
            } else {
                // Pause
                emojiGameState.isPaused = true;
                stopEmojiTimer();
                pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
                pauseBtn.style.background = 'rgba(57, 255, 20, 0.2)';
            }
        }

        function startEmojiTimer() {
            emojiGameState.timer = setInterval(() => {
                if (!emojiGameState.isPaused && emojiGameState.isActive) {
                    emojiGameState.timeLeft--;
                    updateEmojiTimerDisplay();
                    
                    if (emojiGameState.timeLeft <= 0) {
                        endEmojiPuzzle();
                    }
                }
            }, 1000);
        }

        function stopEmojiTimer() {
            if (emojiGameState.timer) {
                clearInterval(emojiGameState.timer);
                emojiGameState.timer = null;
            }
        }

        function updateEmojiTimerDisplay() {
            const timerElement = document.getElementById('emojiTimer');
            timerElement.textContent = emojiGameState.timeLeft;
            
            // Add warning classes
            timerElement.className = 'emoji-timer';
            if (emojiGameState.timeLeft <= 10) {
                timerElement.classList.add('danger');
            } else if (emojiGameState.timeLeft <= 20) {
                timerElement.classList.add('warning');
            }
        }

        function updateEmojiDisplay() {
            document.getElementById('emojiRound').textContent = emojiGameState.round;
            updateEmojiTimerDisplay();
        }

        function startNewRound() {
            // Add new emoji to sequence
            const randomEmoji = emojiOptions[Math.floor(Math.random() * emojiOptions.length)];
            emojiGameState.sequence.push(randomEmoji);
            emojiGameState.userInput = [];
            
            // Clear input container
            const inputContainer = document.getElementById('emojiInputContainer');
            inputContainer.innerHTML = '';
            
            // Clear feedback
            const feedback = document.getElementById('emojiFeedback');
            feedback.style.opacity = '0';
            feedback.className = 'emoji-feedback';
            
            // Show sequence to user
            showEmojiSequence();
        }

        function showEmojiSequence() {
            emojiGameState.showingSequence = true;
            emojiGameState.sequenceIndex = 0;
            
            const sequenceContainer = document.getElementById('emojiSequenceContainer');
            sequenceContainer.innerHTML = '';
            
            // Create sequence display elements
            emojiGameState.sequence.forEach((emoji, index) => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-sequence-item';
                emojiDiv.textContent = emoji;
                sequenceContainer.appendChild(emojiDiv);
            });
            
            // Disable emoji buttons during sequence display
            disableEmojiButtons(true);
            
            // Highlight sequence with delays
            highlightSequence();
        }

        function highlightSequence() {
            const sequenceItems = document.querySelectorAll('.emoji-sequence-item');
            
            function highlightNext() {
                if (emojiGameState.sequenceIndex < sequenceItems.length) {
                    // Remove previous highlight
                    sequenceItems.forEach(item => item.classList.remove('highlighting'));
                    
                    // Add current highlight
                    sequenceItems[emojiGameState.sequenceIndex].classList.add('highlighting');
                    
                    emojiGameState.sequenceIndex++;
                    
                    setTimeout(highlightNext, 800);
                } else {
                    // Sequence display finished
                    setTimeout(() => {
                        // Remove all highlights
                        sequenceItems.forEach(item => item.classList.remove('highlighting'));
                        
                        // Clear sequence display
                        document.getElementById('emojiSequenceContainer').innerHTML = '<p style="color: #39ff14; font-family: \'Roboto Mono\', monospace;">Now repeat the sequence!</p>';
                        
                        // Enable emoji buttons
                        disableEmojiButtons(false);
                        emojiGameState.showingSequence = false;
                    }, 500);
                }
            }
            
            highlightNext();
        }

        function disableEmojiButtons(disabled) {
            const emojiButtons = document.querySelectorAll('.emoji-btn');
            emojiButtons.forEach(btn => {
                btn.disabled = disabled;
                if (disabled) {
                    btn.style.opacity = '0.5';
                    btn.style.pointerEvents = 'none';
                } else {
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'auto';
                }
            });
        }

        function selectEmoji(emoji) {
            if (!emojiGameState.isActive || emojiGameState.isPaused || emojiGameState.showingSequence) return;
            
            // Add to user input
            emojiGameState.userInput.push(emoji);
            
            // Update input display
            updateEmojiInputDisplay();
            
            // Check if input matches sequence so far
            const currentIndex = emojiGameState.userInput.length - 1;
            const isCorrect = emojiGameState.userInput[currentIndex] === emojiGameState.sequence[currentIndex];
            
            if (!isCorrect) {
                // Wrong emoji - end game
                showEmojiFeedback('‚ùå Wrong sequence! Game Over!', 'incorrect');
                setTimeout(() => {
                    endEmojiPuzzle();
                }, 2000);
            } else if (emojiGameState.userInput.length === emojiGameState.sequence.length) {
                // Completed sequence correctly
                showEmojiFeedback('‚úÖ Perfect! Next round!', 'correct');
                emojiGameState.round++;
                updateEmojiDisplay();
                
                setTimeout(() => {
                    startNewRound();
                }, 1500);
            }
        }

        function updateEmojiInputDisplay() {
            const inputContainer = document.getElementById('emojiInputContainer');
            inputContainer.innerHTML = '';
            
            emojiGameState.userInput.forEach(emoji => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-input-item';
                emojiDiv.textContent = emoji;
                inputContainer.appendChild(emojiDiv);
            });
        }

        function showEmojiFeedback(message, type) {
            const feedback = document.getElementById('emojiFeedback');
            feedback.textContent = message;
            feedback.className = `emoji-feedback ${type}`;
            feedback.style.opacity = '1';
        }

        function endEmojiPuzzle() {
            emojiGameState.isActive = false;
            stopEmojiTimer();
            
            // Hide game content, show end screen
            document.getElementById('emojiGameContent').style.display = 'none';
            document.getElementById('emojiEndScreen').style.display = 'block';
            
            // Calculate final score (rounds completed - 1)
            const finalScore = emojiGameState.round - 1;
            document.getElementById('emojiFinalScore').textContent = finalScore;
            
            // Update performance message
            const performance = document.getElementById('emojiPerformance');
            let message = '';
            if (finalScore >= 10) {
                message = 'üèÜ Incredible! You have an amazing memory!';
            } else if (finalScore >= 7) {
                message = 'üéØ Excellent work! Great concentration!';
            } else if (finalScore >= 4) {
                message = 'üëç Good job! Keep practicing!';
            } else {
                message = 'üí™ Nice try! You\'ll do better next time!';
            }
            performance.textContent = message;
            
            // Check and update high score
            updateEmojiHighScore(finalScore);
        }

        function loadEmojiHighScore() {
            const highScore = localStorage.getItem('emojiPuzzleHighScore') || '0';
            document.getElementById('emojiHighScore').textContent = highScore;
        }

        function updateEmojiHighScore(score) {
            const currentHighScore = parseInt(localStorage.getItem('emojiPuzzleHighScore') || '0');
            if (score > currentHighScore) {
                localStorage.setItem('emojiPuzzleHighScore', score.toString());
                document.getElementById('emojiHighScore').textContent = score;
                
                // Show new high score message
                const performance = document.getElementById('emojiPerformance');
                performance.innerHTML = 'üéâ NEW HIGH SCORE! üéâ<br>' + performance.textContent;
            }
        }

        function resetEmojiGameState() {
            emojiGameState = {
                isActive: false,
                isPaused: false,
                timeLeft: 60,
                round: 1,
                sequence: [],
                userInput: [],
                timer: null,
                showingSequence: false,
                sequenceIndex: 0
            };
            
            // Reset pause button
            const pauseBtn = document.getElementById('emojiPauseBtn');
            pauseBtn.textContent = '‚è∏Ô∏è Pause';
            pauseBtn.style.background = 'rgba(0, 0, 0, 0.6)';
            
            // Enable emoji buttons
            disableEmojiButtons(false);
        }

        // Add event listeners for emoji buttons
        document.addEventListener('DOMContentLoaded', function() {
            const emojiButtons = document.querySelectorAll('.emoji-btn');
            emojiButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const emoji = this.dataset.emoji;
                    selectEmoji(emoji);
                });
            });
        });
        
    </script>
    <script src="./script.js"></script>
</body>
</html>