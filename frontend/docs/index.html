<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyPal AI</title>
    <link rel="stylesheet" href="./style.css">
    
</head>
<body>
    <div class="header">
        <h1>StudyPal AI</h1>
        <button class="btn history-btn" onclick="toggleHistory()">ðŸ“Š Study History</button>
    </div>

    <div class="container main-content">
        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-header">
                <div class="ai-avatar">ðŸ¤–</div>
                <h3>AI Study Assistant</h3>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    Hi! I'm StudyPal AI. I'm here to help you stay focused and motivated during your study sessions. Start a study session and I'll support you along the way! ðŸš€
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Ask me anything about studying...">
                <button class="btn" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- Study Section -->
        <div class="study-section">
            <div class="timer-container">
                <div class="progress-ring">
                    <svg>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#00f5ff"/>
                                <stop offset="100%" style="stop-color:#39ff14"/>
                            </linearGradient>
                        </defs>
                        <circle class="progress-bg" cx="100" cy="100" r="90"/>
                        <circle class="progress-bar" cx="100" cy="100" r="90" 
                                stroke-dasharray="565.48" stroke-dashoffset="565.48" id="progressBar"/>
                    </svg>
                </div>
                <div class="timer-display" id="timerDisplay">00:00</div>
                <div class="motivation-text" id="motivationText">Ready to focus? Start your study session!</div>
                <button class="btn start-btn" id="startBtn" onclick="toggleTimer()">Start Study Session</button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalTime">0m</div>
                    <div>Total Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="sessionsCount">0</div>
                    <div>Sessions</div>
                </div>
            </div>

            <div class="games-section" id="gamesSection">
                <h3>ðŸŽ® Game Rewards</h3>
                <div class="unlock-message" id="unlockMessage" style="display: none;">
                    ðŸŽ‰ You've earned a break! Choose a mini-game.
                </div>
                <div class="games-grid">
                    <div class="game-card" id="game1" onclick="playGame('palindrome')">
                        <div>âœ… Palindrome Challenge</div>
                        <small>20min unlock</small>
                    </div>
                    <div class="game-card" id="game2" onclick="playGame('quiz')">
                        <div>ðŸ§  Brain Flash Quiz</div>
                        <small>40min unlock</small>
                    </div>
                    <div class="game-card" id="game3" onclick="playGame('emoji')">
                        <div>ðŸ˜Š Emoji Puzzle</div>
                        <small>40min unlock</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    
    <!-- History Section (Below main content) -->
    <div class="history-section" id="historySection" style="display: none;">
        <div class="history-header">
            <h2>ðŸ“Š Study History</h2>
        </div>
        
        <div class="history-content">
            <div id="historyContent">
                <div id="loadingMessage">Loading study sessions...</div>
            </div>
            <div class="chart-container" id="chartContainer" style="display: none;">
                <canvas id="sessionChart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let historyLoaded = false;
        
        // Toggle history section visibility
        function toggleHistory() {
            const historySection = document.getElementById('historySection');
            const historyBtn = document.querySelector('.history-btn');
            
            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';
                historyBtn.textContent = 'ðŸ“Š Hide History';
                
                // Load history data only when first opened
                if (!historyLoaded) {
                    loadStudyHistory();
                    historyLoaded = true;
                }
                
                // Smooth scroll to history section
                setTimeout(() => {
                    historySection.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100);
            } else {
                historySection.style.display = 'none';
                historyBtn.textContent = 'ðŸ“Š Study History';
                
                // Scroll back to top
                window.scrollTo({ 
                    top: 0, 
                    behavior: 'smooth' 
                });
            }
        }
        
        // Study History functionality
        async function loadStudyHistory() {
            const historyContent = document.getElementById('historyContent');
            const chartContainer = document.getElementById('chartContainer');
            
            try {
                const response = await fetch('http://127.0.0.1:5000/api/get-sessions');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch sessions');
                }
                
                if (data.sessions && data.sessions.length > 0) {
                    displaySessionsTable(data.sessions);
                    displaySessionsChart(data.sessions);
                    chartContainer.style.display = 'block';
                } else {
                    historyContent.innerHTML = '<div class="no-sessions">No study sessions found. Start studying to see your progress!</div>';
                }
            } catch (error) {
                console.error('Error loading study history:', error);
                historyContent.innerHTML = `<div class="error-message">Error loading study history: ${error.message}</div>`;
            }
        }
        
        function displaySessionsTable(sessions) {
            const historyContent = document.getElementById('historyContent');
            
            let tableHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Total Time</th>
                            <th>Session Count</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sessions.forEach(session => {
                const totalMinutes = Math.round(session.total_time / 60);
                const date = new Date(session.timestamp).toLocaleString();
                
                tableHTML += `
                    <tr>
                        <td>#${session.id}</td>
                        <td>${totalMinutes} min</td>
                        <td>${session.session_count}</td>
                        <td>${date}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            historyContent.innerHTML = tableHTML;
        }
        
        function displaySessionsChart(sessions) {
            const ctx = document.getElementById('sessionChart').getContext('2d');
            
            // Prepare data for chart (last 10 sessions)
            const labels = sessions.map(session => `Session #${session.id}`);
            const timeData = sessions.map(session => Math.round(session.total_time / 60)); // Convert to minutes
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Study Time (minutes)',
                        data: timeData,
                        backgroundColor: 'rgba(57, 255, 20, 0.6)',
                        borderColor: 'rgba(57, 255, 20, 1)',
                        borderWidth: 2,
                        borderRadius: 5,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    family: 'Roboto Mono'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0',
                                font: {
                                    family: 'Roboto Mono'
                                }
                            },
                            grid: {
                                color: 'rgba(224, 224, 224, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                font: {
                                    family: 'Roboto Mono'
                                }
                            },
                            grid: {
                                color: 'rgba(224, 224, 224, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
    </script>
    <script src="./script.js"></script>
</body>
</html>