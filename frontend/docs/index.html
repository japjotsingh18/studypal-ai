<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyPal AI</title>
    <link rel="stylesheet" href="./style.css">
    
</head>
<body>
    <div class="header">
        <h1>StudyPal AI</h1>
        <button class="btn history-btn" onclick="toggleHistory()">üìä Study History</button>
    </div>

    <div class="container main-content">
        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-header">
                <div class="ai-avatar">ü§ñ</div>
                <h3>AI Study Assistant</h3>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    Hi! I'm StudyPal AI. I'm here to help you stay focused and motivated during your study sessions. Start a study session and I'll support you along the way! üöÄ
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Ask me anything about studying...">
                <button class="btn" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- Study Section -->
        <div class="study-section">
            <div class="timer-container">
                <div class="progress-ring">
                    <svg>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#00f5ff"/>
                                <stop offset="100%" style="stop-color:#39ff14"/>
                            </linearGradient>
                        </defs>
                        <circle class="progress-bg" cx="100" cy="100" r="90"/>
                        <circle class="progress-bar" cx="100" cy="100" r="90" 
                                stroke-dasharray="565.48" stroke-dashoffset="565.48" id="progressBar"/>
                    </svg>
                </div>
                <div class="timer-display" id="timerDisplay">00:00</div>
                <div class="motivation-text" id="motivationText">Ready to focus? Start your study session!</div>
                <button class="btn start-btn" id="startBtn" onclick="toggleTimer()">Start Study Session</button>
                <button class="btn finish-btn" id="finishBtn" onclick="finishSession()" style="display: none;">Finish Session</button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalTime">0m</div>
                    <div>Total Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="sessionsCount">0</div>
                    <div>Sessions</div>
                </div>
            </div>

            <div class="games-section" id="gamesSection">
                <h3>üéÆ Game Rewards</h3>
                <div class="unlock-message" id="unlockMessage" style="display: none;">
                    üéâ You've earned a break! Choose a mini-game.
                </div>
                <div class="games-grid">
                    <div class="game-card" id="game1" onclick="playGame('palindrome')">
                        <div>‚úÖ Palindrome Challenge</div>
                        <small>20min unlock</small>
                    </div>
                    <div class="game-card" id="game2" onclick="playGame('quiz')">
                        <div>üß† Brain Flash Quiz</div>
                        <small>40min unlock</small>
                    </div>
                    <div class="game-card" id="game3" onclick="playGame('emoji')">
                        <div>üòä Emoji Puzzle</div>
                        <small>40min unlock</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    
    <!-- History Section (Below main content) -->
    <div class="history-section" id="historySection" style="display: none;">
        <div class="history-header">
            <h2>üìä Study History</h2>
        </div>
        
        <div class="history-content">
            <div id="historyContent">
                <div id="loadingMessage">Loading study sessions...</div>
            </div>
            <div class="chart-container" id="chartContainer" style="display: none;">
                <canvas id="sessionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
<div id="customModal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-icon">‚ö†Ô∏è</span>
            <h3 class="modal-title">Finish Session</h3>
        </div>
        <p class="modal-message">
            Are you sure you want to finish this session?<br>
            This will reset your progress and lock all games.
        </p>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">Cancel</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmFinishSession()">Finish Session</button>
        </div>
    </div>
</div>

    <!-- Palindrome Challenge Mini-Game -->
    <div id="palindromeGame" class="palindrome-game-overlay" style="display: none;">
        <div class="palindrome-game-container">
            <div class="palindrome-game-header">
                <h2 class="palindrome-title">üéÆ Palindrome Challenge</h2>
                <p class="palindrome-subtitle">Enter a word or sentence to check if it's a palindrome!</p>
            </div>
            
            <div class="palindrome-input-section">
                <input 
                    type="text" 
                    id="palindromeInput" 
                    class="palindrome-input" 
                    placeholder="Type your text here..."
                    maxlength="100"
                />
            </div>
            
            <div class="palindrome-button-section">
                <button id="checkPalindromeBtn" class="palindrome-check-btn" onclick="checkPalindrome()">
                    Check Palindrome
                </button>
            </div>
            
            <div id="palindromeResult" class="palindrome-result" style="opacity: 0;">
                <p id="palindromeResultText"></p>
            </div>
            
            <div class="palindrome-controls">
                <button class="palindrome-control-btn clear-btn" onclick="clearPalindromeGame()">
                    Clear
                </button>
                <button class="palindrome-control-btn close-btn" onclick="closePalindromeGame()">
                    Close Game
                </button>
            </div>
        </div>
    </div>

    <!-- Brain Flash Quiz Game -->
    <div id="brainFlashQuiz" class="quiz-game-overlay" style="display: none;">
        <div class="quiz-game-container">
            <div class="quiz-header">
                <h2 class="quiz-title">üß† Brain Flash Quiz</h2>
                <div class="quiz-stats">
                    <div class="quiz-timer" id="quizTimer">60</div>
                    <div class="quiz-score">Score: <span id="quizScore">0</span></div>
                    <div class="quiz-high-score">Best: <span id="quizHighScore">0</span></div>
                </div>
            </div>

            <div id="quizGameContent" class="quiz-content">
                <div class="quiz-question-container">
                    <div class="quiz-question-number">Question <span id="questionNumber">1</span></div>
                    <div class="quiz-question" id="quizQuestion">Loading question...</div>
                </div>

                <div class="quiz-options" id="quizOptions">
                    <button class="quiz-option" onclick="selectQuizAnswer(0)">A</button>
                    <button class="quiz-option" onclick="selectQuizAnswer(1)">B</button>
                    <button class="quiz-option" onclick="selectQuizAnswer(2)">C</button>
                    <button class="quiz-option" onclick="selectQuizAnswer(3)">D</button>
                </div>

                <div class="quiz-feedback" id="quizFeedback" style="opacity: 0;"></div>
            </div>

            <div id="quizEndScreen" class="quiz-end-screen" style="display: none;">
                <h3 class="quiz-end-title">üéØ Quiz Complete!</h3>
                <div class="quiz-final-score">
                    Final Score: <span id="finalScore">0</span>
                </div>
                <div class="quiz-performance" id="quizPerformance"></div>
                <div class="quiz-end-controls">
                    <button class="quiz-restart-btn" onclick="startBrainFlashQuiz()">üîÑ Play Again</button>
                    <button class="quiz-close-btn" onclick="closeBrainFlashQuiz()">Close Quiz</button>
                </div>
            </div>

            <div class="quiz-controls">
                <button class="quiz-control-btn quiz-pause-btn" onclick="pauseBrainFlashQuiz()" id="quizPauseBtn">‚è∏Ô∏è Pause</button>
                <button class="quiz-control-btn quiz-exit-btn" onclick="closeBrainFlashQuiz()">‚ùå Exit</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let historyLoaded = false;
        
        // Toggle history section visibility
        function toggleHistory() {
            const historySection = document.getElementById('historySection');
            const historyBtn = document.querySelector('.history-btn');
            
            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';
                historyBtn.textContent = 'üìä Hide History';
                
                // Always reload history data to show latest sessions
                loadStudyHistory();
                historyLoaded = true;
                
                // Smooth scroll to history section
                setTimeout(() => {
                    historySection.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100);
            } else {
                historySection.style.display = 'none';
                historyBtn.textContent = 'üìä Study History';
                
                // Scroll back to top
                window.scrollTo({ 
                    top: 0, 
                    behavior: 'smooth' 
                });
            }
        }
        
        // Study History functionality
        async function loadStudyHistory() {
            const historyContent = document.getElementById('historyContent');
            const chartContainer = document.getElementById('chartContainer');
            
            try {
                const response = await fetch('http://127.0.0.1:5001/api/get-sessions');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch sessions');
                }
                
                if (data.sessions && data.sessions.length > 0) {
                    displaySessionsTable(data.sessions);
                    displaySessionsChart(data.sessions);
                    chartContainer.style.display = 'block';
                } else {
                    historyContent.innerHTML = '<div class="no-sessions">No study sessions found. Start studying to see your progress!</div>';
                }
            } catch (error) {
                console.error('Error loading study history:', error);
                historyContent.innerHTML = `<div class="error-message">Error loading study history: ${error.message}</div>`;
            }
        }
        
        function displaySessionsTable(sessions) {
            const historyContent = document.getElementById('historyContent');
            
            let tableHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Total Time</th>
                            <th>Session Count</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sessions.forEach(session => {
                const totalMinutes = Math.round(session.total_time / 60);
                const date = new Date(session.timestamp).toLocaleString();
                
                tableHTML += `
                    <tr>
                        <td>#${session.id}</td>
                        <td>${totalMinutes} min</td>
                        <td>${session.session_count}</td>
                        <td>${date}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            historyContent.innerHTML = tableHTML;
        }
        
        function displaySessionsChart(sessions) {
            const ctx = document.getElementById('sessionChart').getContext('2d');
            
            // Prepare data for chart (last 10 sessions)
            const labels = sessions.map(session => `Session #${session.id}`);
            const timeData = sessions.map(session => Math.round(session.total_time / 60)); // Convert to minutes
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Study Time (minutes)',
                        data: timeData,
                        backgroundColor: 'rgba(57, 255, 20, 0.6)',
                        borderColor: 'rgba(57, 255, 20, 1)',
                        borderWidth: 2,
                        borderRadius: 5,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    family: 'Roboto Mono'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e0e0e0',
                                font: {
                                    family: 'Roboto Mono'
                                }
                            },
                            grid: {
                                color: 'rgba(224, 224, 224, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e0e0e0',
                                font: {
                                    family: 'Roboto Mono'
                                }
                            },
                            grid: {
                                color: 'rgba(224, 224, 224, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // Function to refresh history if it's currently visible
        function refreshHistoryIfVisible() {
            const historySection = document.getElementById('historySection');
            if (historySection && historySection.style.display !== 'none') {
                console.log('Refreshing history data...');
                loadStudyHistory();
            }
        }
        
        // Palindrome Game Functions
        function openPalindromeGame() {
            const gameOverlay = document.getElementById('palindromeGame');
            gameOverlay.style.display = 'flex';
            
            // Focus on input after a short delay
            setTimeout(() => {
                document.getElementById('palindromeInput').focus();
            }, 300);
            
            // Clear any previous results
            clearPalindromeResult();
        }
        
        function closePalindromeGame() {
            const gameOverlay = document.getElementById('palindromeGame');
            gameOverlay.style.display = 'none';
            
            // Clear input and results
            clearPalindromeGame();
        }
        
        function clearPalindromeGame() {
            document.getElementById('palindromeInput').value = '';
            clearPalindromeResult();
        }
        
        function clearPalindromeResult() {
            const resultDiv = document.getElementById('palindromeResult');
            resultDiv.style.opacity = '0';
            resultDiv.className = 'palindrome-result';
        }
        
        function showPalindromeResult(message, type) {
            const resultDiv = document.getElementById('palindromeResult');
            const resultText = document.getElementById('palindromeResultText');
            
            resultText.textContent = message;
            resultDiv.className = `palindrome-result ${type}`;
            resultDiv.style.opacity = '1';
        }
        
        function isPalindrome(str) {
            // Remove spaces, punctuation, and convert to lowercase
            const cleaned = str.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
            
            // Check if cleaned string equals its reverse
            return cleaned === cleaned.split('').reverse().join('');
        }
        
        function checkPalindrome() {
            const input = document.getElementById('palindromeInput').value.trim();
            
            // Check if input is empty
            if (input === '') {
                showPalindromeResult('‚ö†Ô∏è Please enter something.', 'warning');
                return;
            }
            
            // Check if it's a palindrome
            if (isPalindrome(input)) {
                showPalindromeResult('‚úÖ It\'s a palindrome!', 'success');
            } else {
                showPalindromeResult('‚ùå Not a palindrome.', 'error');
            }
        }
        
        // Add Enter key support for palindrome input
        document.addEventListener('DOMContentLoaded', function() {
            const palindromeInput = document.getElementById('palindromeInput');
            if (palindromeInput) {
                palindromeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPalindrome();
                    }
                });
            }
        });
        
        // Brain Flash Quiz Functions
        let quizState = {
            isActive: false,
            isPaused: false,
            timeLeft: 60,
            score: 0,
            questionCount: 0,
            currentQuestion: null,
            timer: null
        };

        const quizQuestions = [
            // Math Questions
            { question: "What is 15 √ó 8?", options: ["120", "140", "110", "130"], correct: 0 },
            { question: "What is 144 √∑ 12?", options: ["11", "13", "12", "14"], correct: 2 },
            { question: "What is 7¬≤ + 3¬≤?", options: ["58", "49", "40", "52"], correct: 0 },
            { question: "What is 25% of 80?", options: ["15", "25", "20", "30"], correct: 2 },
            { question: "What is ‚àö64?", options: ["6", "8", "10", "7"], correct: 1 },
            { question: "What is 13 + 29?", options: ["42", "41", "43", "40"], correct: 0 },
            { question: "What is 156 - 89?", options: ["67", "77", "57", "69"], correct: 0 },
            { question: "What is 2¬≥ √ó 5?", options: ["30", "35", "40", "45"], correct: 2 },
            { question: "What is 72 √∑ 8?", options: ["8", "9", "10", "7"], correct: 1 },
            { question: "What is 11 √ó 11?", options: ["111", "121", "131", "141"], correct: 1 },
            
            // Logic Questions
            { question: "If today is Wednesday, what day was it 3 days ago?", options: ["Sunday", "Monday", "Saturday", "Tuesday"], correct: 0 },
            { question: "Which number comes next: 2, 4, 8, 16, ?", options: ["24", "32", "28", "20"], correct: 1 },
            { question: "If A=1, B=2, C=3, what does CAB equal?", options: ["312", "321", "123", "132"], correct: 0 },
            { question: "How many sides does a hexagon have?", options: ["5", "7", "6", "8"], correct: 2 },
            { question: "Which is the odd one out?", options: ["Triangle", "Square", "Circle", "Pentagon"], correct: 2 },
            { question: "If 3 cats catch 3 mice in 3 minutes, how many cats catch 100 mice in 100 minutes?", options: ["100", "33", "3", "10"], correct: 2 },
            { question: "What comes next: Monday, Wednesday, Friday, ?", options: ["Sunday", "Tuesday", "Saturday", "Thursday"], correct: 0 },
            { question: "How many minutes are in 2.5 hours?", options: ["120", "130", "150", "140"], correct: 2 },
            { question: "Which number is missing: 5, 10, 15, ?, 25", options: ["18", "20", "22", "24"], correct: 1 },
            { question: "If you're facing North and turn 270¬∞ clockwise, which direction are you facing?", options: ["West", "South", "East", "North"], correct: 0 }
        ];

        function openBrainFlashQuiz() {
            const quizOverlay = document.getElementById('brainFlashQuiz');
            quizOverlay.style.display = 'flex';
            
            // Load high score
            loadQuizHighScore();
            
            // Start the quiz
            startBrainFlashQuiz();
        }

        function closeBrainFlashQuiz() {
            const quizOverlay = document.getElementById('brainFlashQuiz');
            quizOverlay.style.display = 'none';
            
            // Stop quiz if running
            if (quizState.isActive) {
                stopQuizTimer();
                quizState.isActive = false;
            }
            
            // Reset quiz state
            resetQuizState();
        }

        function startBrainFlashQuiz() {
            // Reset quiz state
            quizState = {
                isActive: true,
                isPaused: false,
                timeLeft: 60,
                score: 0,
                questionCount: 0,
                currentQuestion: null,
                timer: null
            };
            
            // Show game content, hide end screen
            document.getElementById('quizGameContent').style.display = 'block';
            document.getElementById('quizEndScreen').style.display = 'none';
            
            // Update display
            updateQuizDisplay();
            
            // Load first question
            loadNextQuestion();
            
            // Start timer
            startQuizTimer();
        }

        function pauseBrainFlashQuiz() {
            if (!quizState.isActive) return;
            
            const pauseBtn = document.getElementById('quizPauseBtn');
            
            if (quizState.isPaused) {
                // Resume
                quizState.isPaused = false;
                startQuizTimer();
                pauseBtn.textContent = '‚è∏Ô∏è Pause';
                pauseBtn.style.background = 'rgba(0, 0, 0, 0.6)';
            } else {
                // Pause
                quizState.isPaused = true;
                stopQuizTimer();
                pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
                pauseBtn.style.background = 'rgba(57, 255, 20, 0.2)';
            }
        }

        function startQuizTimer() {
            quizState.timer = setInterval(() => {
                if (!quizState.isPaused && quizState.isActive) {
                    quizState.timeLeft--;
                    updateTimerDisplay();
                    
                    if (quizState.timeLeft <= 0) {
                        endBrainFlashQuiz();
                    }
                }
            }, 1000);
        }

        function stopQuizTimer() {
            if (quizState.timer) {
                clearInterval(quizState.timer);
                quizState.timer = null;
            }
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('quizTimer');
            timerElement.textContent = quizState.timeLeft;
            
            // Add warning classes
            timerElement.className = 'quiz-timer';
            if (quizState.timeLeft <= 10) {
                timerElement.classList.add('danger');
            } else if (quizState.timeLeft <= 20) {
                timerElement.classList.add('warning');
            }
        }

        function updateQuizDisplay() {
            document.getElementById('quizScore').textContent = quizState.score;
            document.getElementById('questionNumber').textContent = quizState.questionCount + 1;
            updateTimerDisplay();
        }

        function loadNextQuestion() {
            // Get random question
            const randomIndex = Math.floor(Math.random() * quizQuestions.length);
            quizState.currentQuestion = quizQuestions[randomIndex];
            quizState.questionCount++;
            
            // Update question display
            document.getElementById('quizQuestion').textContent = quizState.currentQuestion.question;
            
            // Update options
            const optionButtons = document.querySelectorAll('.quiz-option');
            optionButtons.forEach((btn, index) => {
                btn.textContent = `${String.fromCharCode(65 + index)}. ${quizState.currentQuestion.options[index]}`;
                btn.className = 'quiz-option';
                btn.disabled = false;
            });
            
            // Clear feedback
            const feedback = document.getElementById('quizFeedback');
            feedback.style.opacity = '0';
            feedback.className = 'quiz-feedback';
            
            // Update display
            updateQuizDisplay();
        }

        function selectQuizAnswer(selectedIndex) {
            if (!quizState.isActive || quizState.isPaused) return;
            
            const optionButtons = document.querySelectorAll('.quiz-option');
            const feedback = document.getElementById('quizFeedback');
            const correctIndex = quizState.currentQuestion.correct;
            
            // Disable all buttons
            optionButtons.forEach(btn => btn.disabled = true);
            
            // Show correct/incorrect styling
            optionButtons[selectedIndex].classList.add(selectedIndex === correctIndex ? 'correct' : 'incorrect');
            optionButtons[correctIndex].classList.add('correct');
            
            // Update score and show feedback
            if (selectedIndex === correctIndex) {
                quizState.score++;
                feedback.textContent = '‚úÖ Correct! +1 point';
                feedback.className = 'quiz-feedback correct';
            } else {
                feedback.textContent = '‚ùå Incorrect! Try the next one';
                feedback.className = 'quiz-feedback incorrect';
            }
            
            feedback.style.opacity = '1';
            
            // Update score display
            document.getElementById('quizScore').textContent = quizState.score;
            
            // Load next question after delay
            setTimeout(() => {
                if (quizState.isActive) {
                    loadNextQuestion();
                }
            }, 1500);
        }

        function endBrainFlashQuiz() {
            quizState.isActive = false;
            stopQuizTimer();
            
            // Hide game content, show end screen
            document.getElementById('quizGameContent').style.display = 'none';
            document.getElementById('quizEndScreen').style.display = 'block';
            
            // Update final score
            document.getElementById('finalScore').textContent = quizState.score;
            
            // Update performance message
            const performance = document.getElementById('quizPerformance');
            let message = '';
            if (quizState.score >= 15) {
                message = 'üèÜ Outstanding! You\'re a genius!';
            } else if (quizState.score >= 10) {
                message = 'üéØ Excellent work! Great focus!';
            } else if (quizState.score >= 6) {
                message = 'üëç Good job! Keep practicing!';
            } else {
                message = 'üí™ Nice try! You\'ll do better next time!';
            }
            performance.textContent = message;
            
            // Check and update high score
            updateQuizHighScore();
        }

        function loadQuizHighScore() {
            const highScore = localStorage.getItem('brainFlashQuizHighScore') || '0';
            document.getElementById('quizHighScore').textContent = highScore;
        }

        function updateQuizHighScore() {
            const currentHighScore = parseInt(localStorage.getItem('brainFlashQuizHighScore') || '0');
            if (quizState.score > currentHighScore) {
                localStorage.setItem('brainFlashQuizHighScore', quizState.score.toString());
                document.getElementById('quizHighScore').textContent = quizState.score;
                
                // Show new high score message
                const performance = document.getElementById('quizPerformance');
                performance.innerHTML = 'üéâ NEW HIGH SCORE! üéâ<br>' + performance.textContent;
            }
        }

        function resetQuizState() {
            quizState = {
                isActive: false,
                isPaused: false,
                timeLeft: 60,
                score: 0,
                questionCount: 0,
                currentQuestion: null,
                timer: null
            };
            
            // Reset pause button
            const pauseBtn = document.getElementById('quizPauseBtn');
            pauseBtn.textContent = '‚è∏Ô∏è Pause';
            pauseBtn.style.background = 'rgba(0, 0, 0, 0.6)';
        }
        
    </script>
    <script src="./script.js"></script>
</body>
</html>